(function(){var e,t,n,r,i,s,o,u,a,f,l={}.hasOwnProperty,c=function(e,t){function r(){this.constructor=e}for(var n in t)l.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};f=require("stream"),s=require("./errors"),a=function(e){var t,n,r,i,s,o;if(r=window[e])return r;t=e[0].toUppercase()+e.substring(1),o=["moz","webkit","ms","o"];for(i=0,s=o.length;i<s;i++){n=o[i],r=window[n+t];if(r!=null)break}return r},u=a("indexedDB"),t=a("IDBTransaction"),e=a("IDBKeyRange"),i=function(t){function n(e){this.idb=e,this.readable=!0,process.nextTick(this.init.bind(this))}return c(n,t),n.prototype.init=function(){var t,n,r,i,s=this;return i=this.idb.db.transaction([this.idb.storename],"readonly"),r=i.objectStore(this.idb.storename),t=e.lowerBound(0),n=r.openCursor(t),n.onsuccess=function(e){var t;if(!(t=e.target.result))return;return s.emit("data",t.value),t["continue"]()},n.onerror=function(e){return s.emit("error",e)},i.oncomplete=function(){return s.end()}},n.prototype.write=function(e,t){return this.emit("data",e)},n.prototype.end=function(){return this.emit("end")},n}(f.Stream),o=function(e,t){if(t)return t(e);throw e},n=function(){function e(e,t){var n;t==null&&(t={});if(typeof e!="string")return n=new s.InitializationError("Must provide a location for the database"),o(n);this._options={createIfMissing:t.createIfMissing||!1,errorIfExists:t.errorIfExists||!1,encoding:t.encoding||"json",sync:!1},this.storename="indexedup",this._location=e,this._status="new"}return e.prototype.open=function(e){var t,n,r=this;return n=u.open(this._location),t=function(n){var r;try{n=this.getStore(!0)}catch(i){}return this._options.errorIfExists===!0&&n!=null?(r=new s.OpenError("Database already exists (errorIfExists: true)"),o(r,e),!0):this._options.createIfMissing===!1&&!n?(r=new s.OpenError("Database doesn't exist (createIfMissing: false)"),o(r,e),!0):(t=function(){},!1)},n.onsuccess=function(i){r.db=n.result;if(t.call(r))return;return r._status="open",typeof e=="function"?e(null,r):void 0},n.onerror=function(t){var n;return n=new s.OpenError(t),o(n,e)},n.onupgradeneeded=function(e){var n;if(t.call(r))return;return n=e.target.result,r.store=n.createObjectStore(r.storename,{keyPath:"key"})}},e.prototype.close=function(e){var t;return this.isOpen()?(this.db=null,this._status="closed",e()):(t=new s.CloseError("Cannot close unopened database"),o(t,e))},e.prototype.isOpen=function(){return this._status==="open"},e.prototype.isClosed=function(){return this._status==="closed"},e.prototype.getTransaction=function(e){var t;return t=e?"readwrite":"readonly",this.db.transaction([this.storename],t)},e.prototype.getStore=function(e,t){return t==null&&(t=this.getTransaction(e)),t.objectStore(this.storename)},e.prototype.put=function(e,t,n,r){var i,u,a;typeof n=="function"&&(a=[r,n],n=a[0],r=a[1]);if(!this.isOpen())return i=new s.WriteError("Database has not been opened"),o(i,r);if(e==null)return i=new s.WriteError("Invalid key"),o(i,r);if(t==null)return i=new s.WriteError("Invalid data"),o(i,r);u=this.getStore(!0).put({key:e,value:t}),u.onsuccess=function(e){return typeof r=="function"?r(null,u.result):void 0},u.onerror=function(e){return i=new s.WriteError(e),o(i,r)}},e.prototype.get=function(e,t,n){var r,i,u;typeof t=="function"&&(u=[n,t],t=u[0],n=u[1]);if(!this.isOpen())return r=new s.ReadError("Database has not been opened"),o(r,n);if(e==null)return r=new s.ReadError("Invalid key"),o(r,n);i=this.getStore().get(e),i.onsuccess=function(e){var t,r;return(t=(r=i.result)!=null?r.value:void 0)?typeof n=="function"?n(null,t):void 0:i.onerror()},i.onerror=function(t){return t=new s.NotFoundError("Key not found in database ["+e+"]"),o(t,n)}},e.prototype.del=function(e,t,n){var r,i,u;typeof t=="function"&&(u=[n,t],t=u[0],n=u[1]);if(!this.isOpen())return r=new s.WriteError("Database has not been opened"),o(r,n);if(e==null)return r=new s.WriteError("Invalid key"),o(r,n);i=this.getStore(!0)["delete"](e),i.onsuccess=function(e){return typeof n=="function"?n(null,i.result):void 0},i.onerror=function(e){r=new s.WriteError(e);if(n)return n(r);throw r}},e.prototype.batch=function(e,t){var n,r,i,u,a,f;if(!this.isOpen())return n=new s.WriteError("Database has not been opened"),o(n,t);u=this.getTransaction(!0),i=this.getStore(null,u);for(a=0,f=e.length;a<f;a++){r=e[a];if(r.type!=null&&r.key!=null)switch(r.type){case"put":i.put({key:r.key,value:r.value});break;case"del":i["delete"](r.key)}}u.oncomplete=function(e){return t()},u.onerror=function(e){return n=new s.WriteError(e),o(n,t)}},e.prototype.readStream=function(){return new i(this)},e}(),r=function(e,t,r){var i,s;return typeof t=="function"&&(s=[r,t],t=s[0],r=s[1]),i=new n(e,t),i.open(r)},(typeof module!="undefined"&&module!==null?module.exports:void 0)?module.exports=r:window.indexedup=r}).call(this)